<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>社区项目（下） | realheisenberg</title><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">社区项目（下）</h1><a id="logo" href="/.">realheisenberg</a><p class="description">liusai201@mails.ucas.ac.cn</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">社区项目（下）</h1><div class="post-meta"><a href="/2021/08/23/%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%B8%8B%EF%BC%89/#comments" class="comment-count"></a><p><span class="date">Aug 23, 2021</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><h2 id="社区项目"><a href="#社区项目" class="headerlink" title="社区项目"></a>社区项目</h2><h3 id="18-Redis实现点赞功能"><a href="#18-Redis实现点赞功能" class="headerlink" title="18. Redis实现点赞功能"></a>18. Redis实现点赞功能</h3><p>在pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在application.properties中配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RedisProperties</span></span><br><span class="line"><span class="meta">spring.redis.database</span>=<span class="string">11</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">localhost</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br></pre></td></tr></table></figure>

<p>在config包下新建RedisConfig配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置key的序列化方式</span></span><br><span class="line">        template.setKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">//设置value的序列化方式</span></span><br><span class="line">        template.setValueSerializer(RedisSerializer.json());</span><br><span class="line">        <span class="comment">//设置hash的key的序列化方式</span></span><br><span class="line">        template.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">//设置hash的value的序列化方式</span></span><br><span class="line">        template.setHashValueSerializer(RedisSerializer.json());</span><br><span class="line"></span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在util包下创建RedisKeyUtil工具类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisKeyUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPLIT = <span class="string">&quot;:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_ENTITY_LIKE = <span class="string">&quot;like:entity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//某个实体的赞</span></span><br><span class="line">    <span class="comment">//like:entity:entityType:entityId -&gt; set(userId)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getEntityLikeKey</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建LikeService类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LikeService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="comment">//点赞</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">like</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">        <span class="keyword">boolean</span> isMember = redisTemplate.opsForSet().isMember(entityLikeKey, userId);</span><br><span class="line">        <span class="keyword">if</span> (isMember) &#123;</span><br><span class="line">            redisTemplate.opsForSet().remove(entityLikeKey, userId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            redisTemplate.opsForSet().add(entityLikeKey, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询某实体点赞的数量</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">findEntityLikeCount</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForSet().size(entityLikeKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询某人对某实体的点赞状态</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findEntityLikeStatus</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建LikeController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LikeController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LikeService likeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/like&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">like</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        User user = hostHolder.getUser();</span><br><span class="line">        <span class="comment">//点赞</span></span><br><span class="line">        likeService.like(user.getId(), entityType, entityId);</span><br><span class="line">        <span class="comment">//数量</span></span><br><span class="line">        <span class="keyword">long</span> likeCount = likeService.findEntityLikeCount(entityType, entityId);</span><br><span class="line">        <span class="comment">//状态</span></span><br><span class="line">        <span class="keyword">int</span> likeStatus = likeService.findEntityLikeStatus(user.getId(), entityType, entityId);</span><br><span class="line">        <span class="comment">//返回的结果</span></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line">        map.put(<span class="string">&quot;likeStatus&quot;</span>, likeStatus);</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="keyword">null</span>, map);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建discuss.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">like</span>(<span class="params">btn, entityType, entityId</span>) </span>&#123;</span><br><span class="line">    $.post(</span><br><span class="line">        CONTEXT_PATH + <span class="string">&quot;/like&quot;</span>,</span><br><span class="line">        &#123;<span class="string">&quot;entityType&quot;</span>:entityType,<span class="string">&quot;entityId&quot;</span>:entityId&#125;,</span><br><span class="line">        <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">            data = $.parseJSON(data);</span><br><span class="line">            <span class="keyword">if</span> (data.code == <span class="number">0</span>) &#123;</span><br><span class="line">                $(btn).children(<span class="string">&quot;i&quot;</span>).text(data.likeCount);</span><br><span class="line">                $(btn).children(<span class="string">&quot;b&quot;</span>).text(data.likeStatus == <span class="number">1</span> ? <span class="string">&quot;已赞&quot;</span> : <span class="string">&quot;赞&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                alert(data.msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改HomeController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> <span class="keyword">implements</span> <span class="title">CommunityConstant</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LikeService likeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/index&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIndexPage</span><span class="params">(Model model, Page page)</span></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">                <span class="keyword">long</span> likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());</span><br><span class="line">                map.put(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line"></span><br><span class="line">                discussPosts.add(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;discussPosts&quot;</span>, discussPosts);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改DiscussPostController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点赞数量</span></span><br><span class="line"><span class="keyword">long</span> likeCount = likeService.findEntityLikeCount(ENTITY_TYPE_POST, discussPostId);</span><br><span class="line">model.addAttribute(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line"><span class="comment">//点赞状态</span></span><br><span class="line"><span class="keyword">int</span> likeStatus = hostHolder.getUser() == <span class="keyword">null</span> ? <span class="number">0</span> : likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_POST, discussPostId);</span><br><span class="line">model.addAttribute(<span class="string">&quot;likeStatus&quot;</span>, likeStatus);</span><br></pre></td></tr></table></figure>

<h4 id="我收到的赞"><a href="#我收到的赞" class="headerlink" title="我收到的赞"></a>我收到的赞</h4><p>修改RedisKeyUtil类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisKeyUtil</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_USER_LIKE = <span class="string">&quot;like:user&quot;</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//某个用户收到的赞</span></span><br><span class="line">    <span class="comment">//like:user:userId -&gt; int</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUserLikeKey</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PREFIX_USER_LIKE + SPLIT + userId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改LikeService类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点赞</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">like</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId, <span class="keyword">int</span> entityUserId)</span> </span>&#123;</span><br><span class="line">    redisTemplate.execute(<span class="keyword">new</span> SessionCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(RedisOperations redisOperations)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">            String entityLikeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);</span><br><span class="line">            String userLikeKey = RedisKeyUtil.getUserLikeKey(entityUserId);</span><br><span class="line">            <span class="keyword">boolean</span> isMember = redisOperations.opsForSet().isMember(entityLikeKey, userId);</span><br><span class="line">            redisOperations.multi();        <span class="comment">//开启事务</span></span><br><span class="line">            <span class="keyword">if</span> (isMember) &#123;</span><br><span class="line">                redisOperations.opsForSet().remove(entityLikeKey, userId);</span><br><span class="line">                redisOperations.opsForValue().decrement(userLikeKey);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                redisOperations.opsForSet().add(entityLikeKey, userId);</span><br><span class="line">                redisOperations.opsForValue().increment(userLikeKey);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> redisOperations.exec();      <span class="comment">//结束事务</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询某个用户获得赞的数量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findUserLikeCount</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    String userLikeKey = RedisKeyUtil.getUserLikeKey(userId);</span><br><span class="line">    Integer count = (Integer) redisTemplate.opsForValue().get(userLikeKey);</span><br><span class="line">    <span class="keyword">return</span> count == <span class="keyword">null</span> ? <span class="number">0</span> : count.intValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改LikeController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">like</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId, <span class="keyword">int</span> entityUserId)</span> </span>&#123;</span><br><span class="line">    likeService.like(user.getId(), entityType, entityId, entityUserId);</span><br></pre></td></tr></table></figure>

<p>修改discuss.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">like</span>(<span class="params">btn, entityType, entityId, entityUserId</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#123;<span class="string">&quot;entityType&quot;</span>:entityType,<span class="string">&quot;entityId&quot;</span>:entityId,<span class="string">&quot;entityUserId&quot;</span>:entityUserId&#125;,</span><br></pre></td></tr></table></figure>

<h4 id="用户个人主页"><a href="#用户个人主页" class="headerlink" title="用户个人主页"></a>用户个人主页</h4><p>修改UserController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LikeService likeService;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//个人主页</span></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hetProfilePage</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="keyword">int</span> userId, Model model)</span> </span>&#123;</span><br><span class="line">        User user = userService.findUserById(userId);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;该用户不存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//用户</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        <span class="comment">//点赞数量</span></span><br><span class="line">        <span class="keyword">int</span> likeCount = likeService.findUserLikeCount(userId);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;likeCount&quot;</span>, likeCount);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/profile&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="19-Redis实现关注、取消关注"><a href="#19-Redis实现关注、取消关注" class="headerlink" title="19. Redis实现关注、取消关注"></a>19. Redis实现关注、取消关注</h3><p>修改RedisKeyUtil：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_FOLLOWEE = <span class="string">&quot;followee&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_FOLLOWER = <span class="string">&quot;follower&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//某个用户关注的实体</span></span><br><span class="line"><span class="comment">//followee:userId:entityType -&gt; zset(entityId, now)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getFolloweeKey</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_FOLLOWEE + SPLIT + userId + SPLIT + entityType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//某个实体拥有的粉丝</span></span><br><span class="line"><span class="comment">//follower:entityType:entityId -&gt; zset(userId, now)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getFollowerKey</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_FOLLOWER + SPLIT + entityType + SPLIT +entityId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建FollowService类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FollowService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">follow</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;      <span class="comment">//关注</span></span><br><span class="line">        redisTemplate.execute(<span class="keyword">new</span> SessionCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(RedisOperations redisOperations)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);</span><br><span class="line">                redisOperations.multi();</span><br><span class="line">                redisOperations.opsForZSet().add(followeeKey, entityId, System.currentTimeMillis());</span><br><span class="line">                redisOperations.opsForZSet().add(followerKey, userId, System.currentTimeMillis());</span><br><span class="line">                <span class="keyword">return</span> redisOperations.exec();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unfollow</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;        <span class="comment">//取关</span></span><br><span class="line">        redisTemplate.execute(<span class="keyword">new</span> SessionCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">execute</span><span class="params">(RedisOperations redisOperations)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">                String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">                String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);</span><br><span class="line">                redisOperations.multi();</span><br><span class="line">                redisOperations.opsForZSet().remove(followeeKey, entityId);</span><br><span class="line">                redisOperations.opsForZSet().remove(followerKey, userId);</span><br><span class="line">                <span class="keyword">return</span> redisOperations.exec();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建FollowController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FollowController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FollowService followService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/follow&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">follow</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        User user = hostHolder.getUser();</span><br><span class="line">        followService.follow(user.getId(),  entityType, entityId);</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="string">&quot;已关注！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/unfollow&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">unfollow</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">        User user = hostHolder.getUser();</span><br><span class="line">        followService.unfollow(user.getId(),  entityType, entityId);</span><br><span class="line">        <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="string">&quot;已取消关注！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在CommunityConstant中添加用户实体类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ENTITY_TYPE_USER = <span class="number">3</span>;       <span class="comment">//实体类型：用户</span></span><br></pre></td></tr></table></figure>

<p>修改profile.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$(<span class="string">&quot;.follow-btn&quot;</span>).click(follow);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">follow</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> btn = <span class="built_in">this</span>;</span><br><span class="line">	<span class="keyword">if</span>($(btn).hasClass(<span class="string">&quot;btn-info&quot;</span>)) &#123;</span><br><span class="line">		<span class="comment">// 关注TA</span></span><br><span class="line">		$.post(</span><br><span class="line">			CONTEXT_PATH + <span class="string">&quot;/follow&quot;</span>,</span><br><span class="line">			&#123;<span class="string">&quot;entityType&quot;</span>:<span class="number">3</span>,<span class="string">&quot;entityId&quot;</span>:$(btn).prev().val()&#125;,</span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">				data = $.parseJSON(data);</span><br><span class="line">				<span class="keyword">if</span> (data.code == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="built_in">window</span>.location.reload();</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					alert(data.msg);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 取消关注</span></span><br><span class="line">		$.post(</span><br><span class="line">			CONTEXT_PATH + <span class="string">&quot;/unfollow&quot;</span>,</span><br><span class="line">			&#123;<span class="string">&quot;entityType&quot;</span>:<span class="number">3</span>,<span class="string">&quot;entityId&quot;</span>:$(btn).prev().val()&#125;,</span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">				data = $.parseJSON(data);</span><br><span class="line">				<span class="keyword">if</span> (data.code == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="built_in">window</span>.location.reload();</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					alert(data.msg);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="统计关注数、粉丝数"><a href="#统计关注数、粉丝数" class="headerlink" title="统计关注数、粉丝数"></a>统计关注数、粉丝数</h4><p>在FollowService中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询某用户关注实体的数量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">findFolloweeCount</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType)</span> </span>&#123;</span><br><span class="line">    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().zCard(followeeKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询某实体的粉丝数量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">findFollowerCount</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">    String followerKey = RedisKeyUtil.getFollowerKey(entityType, entityId);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().zCard(followerKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询当前用户是否已关注该实体</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasFollowed</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);</span><br><span class="line">    <span class="keyword">return</span> redisTemplate.opsForZSet().score(followeeKey, entityId) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改UserController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FollowService followService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hetProfilePage</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="keyword">int</span> userId, Model model)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//关注数量</span></span><br><span class="line">    <span class="keyword">long</span> followeeCount = followService.findFolloweeCount(userId, ENTITY_TYPE_USER);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;followeeCount&quot;</span>, followeeCount);</span><br><span class="line">    <span class="comment">//粉丝数量</span></span><br><span class="line">    <span class="keyword">long</span> followerCount = followService.findFollowerCount(ENTITY_TYPE_USER, userId);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;followerCount&quot;</span>, followerCount);</span><br><span class="line">    <span class="comment">//是否已关注</span></span><br><span class="line">    <span class="keyword">boolean</span> hasFollowed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (hostHolder.getUser() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        hasFollowed = followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;hasFollowed&quot;</span>, hasFollowed);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/profile&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关注列表、粉丝列表"><a href="#关注列表、粉丝列表" class="headerlink" title="关注列表、粉丝列表"></a>关注列表、粉丝列表</h4><p>在FollowService中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询某用户关注的人</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; findFollowees(<span class="keyword">int</span> userId, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit) &#123;</span><br><span class="line">    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);</span><br><span class="line">    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (targetIds == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Integer targetId : targetIds) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        User user = userService.findUserById(targetId);</span><br><span class="line">        map.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        Double score = redisTemplate.opsForZSet().score(followeeKey, targetId);</span><br><span class="line">        map.put(<span class="string">&quot;followTime&quot;</span>, <span class="keyword">new</span> Date(score.longValue()));</span><br><span class="line">        list.add(map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询某用户的粉丝</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; findFollowers(<span class="keyword">int</span> userId, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit) &#123;</span><br><span class="line">    String followerKey = RedisKeyUtil.getFollowerKey(ENTITY_TYPE_USER, userId);</span><br><span class="line">     Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followerKey, offset, offset + limit - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (targetIds == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Integer targetId : targetIds) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        User user = userService.findUserById(targetId);</span><br><span class="line">        map.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        Double score = redisTemplate.opsForZSet().score(followerKey, targetId);</span><br><span class="line">        map.put(<span class="string">&quot;followTime&quot;</span>, <span class="keyword">new</span> Date(score.longValue()));</span><br><span class="line">        list.add(map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在FollowController中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/followees/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFollowees</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="keyword">int</span> userId, Page page, Model model)</span> </span>&#123;</span><br><span class="line">    User user = userService.findUserById(userId);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;用户不存在！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line">    page.setLimit(<span class="number">5</span>);;</span><br><span class="line">    page.setPath(<span class="string">&quot;/followees/&quot;</span> + userId);</span><br><span class="line">    page.setRows((<span class="keyword">int</span>) followService.findFolloweeCount(userId, ENTITY_TYPE_USER));</span><br><span class="line"></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowees(userId, page.getOffset(), page.getLimit());</span><br><span class="line">    <span class="keyword">if</span> (userList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : userList) &#123;</span><br><span class="line">            User u = (User) map.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;hasFollowed&quot;</span>, hasFollowed(u.getId()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;users&quot;</span>, userList);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/followee&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/followers/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFollowers</span><span class="params">(<span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="keyword">int</span> userId, Page page, Model model)</span> </span>&#123;</span><br><span class="line">    User user = userService.findUserById(userId);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;用户不存在！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line">    page.setLimit(<span class="number">5</span>);;</span><br><span class="line">    page.setPath(<span class="string">&quot;/followers/&quot;</span> + userId);</span><br><span class="line">    page.setRows((<span class="keyword">int</span>) followService.findFollowerCount(ENTITY_TYPE_USER, userId));</span><br><span class="line"></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowers(userId, page.getOffset(), page.getLimit());</span><br><span class="line">    <span class="keyword">if</span> (userList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : userList) &#123;</span><br><span class="line">            User u = (User) map.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;hasFollowed&quot;</span>, hasFollowed(u.getId()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;users&quot;</span>, userList);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/follower&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasFollowed</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hostHolder.getUser() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="20-优化登录模块"><a href="#20-优化登录模块" class="headerlink" title="20. 优化登录模块"></a>20. 优化登录模块</h3><h4 id="使用Redis存储验证码"><a href="#使用Redis存储验证码" class="headerlink" title="使用Redis存储验证码"></a>使用Redis存储验证码</h4><p>验证码使用频繁、不需要永久保存、解决Session共享问题</p>
<p>修改RedisKeyUtil：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_KAPTCHA = <span class="string">&quot;kaptcha&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//登录验证码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getKaptchaKey</span><span class="params">(String owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_KAPTCHA + SPLIT + owner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改LoginController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/kaptcha&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getKaptcha</span><span class="params">(HttpServletResponse response<span class="comment">/*, HttpSession session*/</span>)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//验证码的归属</span></span><br><span class="line">    String kaptchaOwner = CommunityUtil.generateUUID();</span><br><span class="line">    Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">&quot;kaptchaOwner&quot;</span>, kaptchaOwner);</span><br><span class="line">    cookie.setMaxAge(<span class="number">60</span>);</span><br><span class="line">    cookie.setPath(contextPath);</span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">    <span class="comment">//将验证码存入Redis</span></span><br><span class="line">    String redisKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);</span><br><span class="line">    redisTemplate.opsForValue().set(redisKey, text, <span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/login&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(String username, String password, String code, <span class="keyword">boolean</span> rememberme,</span></span></span><br><span class="line"><span class="function"><span class="params">                    Model model, <span class="comment">/*HttpSession session, */</span>HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="meta">@CookieValue(&quot;kaptchaOwner&quot;)</span> String kaptchaOwner)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//检查验证码</span></span><br><span class="line">    String kaptcha = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(kaptchaOwner)) &#123;</span><br><span class="line">        String redisKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);</span><br><span class="line">        kaptcha = (String) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用Redis存储登录凭证"><a href="#使用Redis存储登录凭证" class="headerlink" title="使用Redis存储登录凭证"></a>使用Redis存储登录凭证</h4><p>修改RedisKeyUtil：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_TICKET = <span class="string">&quot;ticket&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//登录凭证</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getTicketKey</span><span class="params">(String ticket)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_TICKET + SPLIT + ticket;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在LoginTicketMapper中添加@Deprecated注解，表示方法已废弃</p>
<p>修改UserService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">login</span><span class="params">(String username, String password, <span class="keyword">int</span> expiredSeconds)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    String redisKey = RedisKeyUtil.getTicketKey(loginTicket.getTicket());</span><br><span class="line">    redisTemplate.opsForValue().set(redisKey, loginTicket);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">(String ticket)</span> </span>&#123;     <span class="comment">//退出登录</span></span><br><span class="line">    String redisKey = RedisKeyUtil.getTicketKey(ticket);</span><br><span class="line">    LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">    loginTicket.setStatus(<span class="number">1</span>);</span><br><span class="line">    redisTemplate.opsForValue().set(redisKey, loginTicket);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LoginTicket <span class="title">findLoginTicket</span><span class="params">(String ticket)</span> </span>&#123;</span><br><span class="line">    String redisKey = RedisKeyUtil.getTicketKey(ticket);</span><br><span class="line">    <span class="keyword">return</span> (LoginTicket) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用Redis存储用户信息"><a href="#使用Redis存储用户信息" class="headerlink" title="使用Redis存储用户信息"></a>使用Redis存储用户信息</h4><p>修改RedisKeyUtil：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_USER = <span class="string">&quot;user&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//用户</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUserKey</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_USER + SPLIT + userId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>修改UserService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(<span class="keyword">int</span> id)</span></span>&#123;</span><br><span class="line">    User user = getCache(id);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">        user = initCache(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">activation</span><span class="params">(<span class="keyword">int</span> userId, String code)</span> </span>&#123;        <span class="comment">//激活用户</span></span><br><span class="line">    User user = userMapper.selectById(userId);</span><br><span class="line">    <span class="keyword">if</span> (user.getStatus() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_REPEAT;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.getActivationCode().equals(code)) &#123;</span><br><span class="line">        userMapper.updateStatus(userId, <span class="number">1</span>);</span><br><span class="line">        clearCache(userId);		<span class="comment">//清除缓存</span></span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateHeader</span><span class="params">(<span class="keyword">int</span> userId, String headerUrl)</span> </span>&#123;     <span class="comment">//用户上传头像</span></span><br><span class="line">    <span class="keyword">int</span> rows = userMapper.updateHeader(userId, headerUrl);</span><br><span class="line">    clearCache(userId);</span><br><span class="line">    <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1. 优先从缓存中取用户信息</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> User <span class="title">getCache</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    String redisKey = RedisKeyUtil.getUserKey(userId);</span><br><span class="line">    <span class="keyword">return</span> (User) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2. 缓存中没有时初始化缓存数据</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> User <span class="title">initCache</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    User user = userMapper.selectById(userId);</span><br><span class="line">    String redisKey = RedisKeyUtil.getUserKey(userId);</span><br><span class="line">    redisTemplate.opsForValue().set(redisKey, user, <span class="number">3600</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//3. 数据变更时清除缓存数据</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearCache</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    String redisKey = RedisKeyUtil.getUserKey(userId);</span><br><span class="line">    redisTemplate.delete(redisKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="21-Kafka发送系统通知"><a href="#21-Kafka发送系统通知" class="headerlink" title="21. Kafka发送系统通知"></a>21. Kafka发送系统通知</h3><p>评论、点赞、关注后发布通知</p>
<p>解压kafka安装包，配置config/zookeeper.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dataDir</span>=<span class="string">d:/work/data/zookeeper		#配置数据保存地址</span></span><br></pre></td></tr></table></figure>

<p>配置server.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">log.dirs</span>=<span class="string">d:/work/data/kafka-logs		#配置日志存放路径</span></span><br></pre></td></tr></table></figure>

<p>修改consumer.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">group.id</span>=<span class="string">community-consumer-group		#修改组名</span></span><br></pre></td></tr></table></figure>

<h4 id="命令行使用Kafka"><a href="#命令行使用Kafka" class="headerlink" title="命令行使用Kafka"></a>命令行使用Kafka</h4><p>启动zookeeper：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\&gt;cd kafka_2.12-2.2.0</span><br><span class="line">E:\kafka_2.12-2.2.0&gt;bin\windows\zookeeper-server-start.bat config\zookeeper.properties</span><br></pre></td></tr></table></figure>

<p>启动kafka：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\&gt;cd kafka_2.12-2.2.0</span><br><span class="line">E:\kafka_2.12-2.2.0&gt;bin\windows\kafka-server-start.bat config\server.properties</span><br></pre></td></tr></table></figure>

<p>生产者发消息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">E:\&gt;cd kafka_2.12-2.2.0\bin\windows</span><br><span class="line">E:\kafka_2.12-2.2.0\bin\windows&gt;kafka-topics.bat --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic test</span><br><span class="line">E:\kafka_2.12-2.2.0\bin\windows&gt;kafka-console-producer.bat --broker-list localhost:9092 --topic test</span><br><span class="line">&gt;hello</span><br><span class="line">&gt;world</span><br></pre></td></tr></table></figure>

<p>消费者接收消息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E:\&gt;cd kafka_2.12-2.2.0\bin\windows</span><br><span class="line">E:\kafka_2.12-2.2.0\bin\windows&gt;kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic test --from-beginning</span><br></pre></td></tr></table></figure>

<h4 id="Spring整合Kafka"><a href="#Spring整合Kafka" class="headerlink" title="Spring整合Kafka"></a>Spring整合Kafka</h4><p>在pom.xml中引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置application.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># KafkaProperties</span></span><br><span class="line"><span class="meta">spring.kafka.bootstrap-servers</span>=<span class="string">localhost:9092</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.group-id</span>=<span class="string">community-consumer-group</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.enable-auto-commit</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.auto-commit-interval</span>=<span class="string">3000</span></span><br></pre></td></tr></table></figure>

<h4 id="发送通知"><a href="#发送通知" class="headerlink" title="发送通知"></a>发送通知</h4><p>在entity包下创建Event事件实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> userId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> entityType;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> entityId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> entityUserId;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//setter、getter，修改get方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建event包，创建EventProducer类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventProducer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理事件</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireEvent</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//将事件以json格式发布到指定主题</span></span><br><span class="line">        kafkaTemplate.send(event.getTopic(), JSONObject.toJSONString(event));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在CommunityConstant中添加常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String TOPIC_COMMENT = <span class="string">&quot;comment&quot;</span>;       <span class="comment">//主题类型：评论</span></span><br><span class="line">String TOPIC_LIKE = <span class="string">&quot;like&quot;</span>;     <span class="comment">//主题类型：点赞</span></span><br><span class="line">String TOPIC_FOLLOW = <span class="string">&quot;follow&quot;</span>;     <span class="comment">//主题类型：关注</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> SYSTEM_USER_ID = <span class="number">1</span>;     <span class="comment">//系统用户id</span></span><br></pre></td></tr></table></figure>

<p>在event包下创建EventConsumer类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventConsumer</span> <span class="keyword">implements</span> <span class="title">CommunityConstant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(EventConsumer.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener(topics = &#123;TOPIC_COMMENT, TOPIC_LIKE, TOPIC_FOLLOW&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCommentMessage</span><span class="params">(ConsumerRecord record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (record == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;消息内容为空！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Event event = JSONObject.parseObject(record.value().toString(), Event.class);</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;消息格式错误！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//发送站内通知</span></span><br><span class="line">        Message message = <span class="keyword">new</span> Message();</span><br><span class="line">        message.setFromId(SYSTEM_USER_ID);</span><br><span class="line">        message.setToId(event.getEntityUserId());</span><br><span class="line">        message.setConversationId(event.getTopic());</span><br><span class="line">        message.setCreateTime(<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; content = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        content.put(<span class="string">&quot;userId&quot;</span>, event.getUserId());</span><br><span class="line">        content.put(<span class="string">&quot;entityType&quot;</span>, event.getEntityType());</span><br><span class="line">        content.put(<span class="string">&quot;entityId&quot;</span>, event.getEntityId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!event.getData().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : event.getData().entrySet()) &#123;</span><br><span class="line">                content.put(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        message.setContent(JSONObject.toJSONString(content));</span><br><span class="line">        messageService.addMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CommentController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EventProducer eventProducer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscussPostService discussPostService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">addComment</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="keyword">int</span> discussPostId, Comment comment)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//触发评论事件</span></span><br><span class="line">    Event event = <span class="keyword">new</span> Event()</span><br><span class="line">            .setTopic(TOPIC_COMMENT)</span><br><span class="line">            .setUserId(hostHolder.getUser().getId())</span><br><span class="line">            .setEntityType(comment.getEntityType())</span><br><span class="line">            .setEntityId(comment.getEntityId())</span><br><span class="line">            .setData(<span class="string">&quot;postId&quot;</span>, discussPostId);</span><br><span class="line">    <span class="keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST) &#123;</span><br><span class="line">        DiscussPost target = discussPostService.findDiscussPostById(comment.getEntityId());</span><br><span class="line">        event.setEntityUserId(target.getUserId());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_COMMENT) &#123;</span><br><span class="line">        Comment target = commentService.findCommentById(comment.getEntityId());</span><br><span class="line">        event.setEntityUserId(target.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在CommentMapper中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Comment <span class="title">selectCommentById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在comment-mapper.xml中写sql：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectCommentById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Comment&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from comment</span><br><span class="line">    where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在CommentService中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Comment <span class="title">findCommentById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> commentMapper.selectCommentById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改LikeController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EventProducer eventProducer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/like&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">like</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId, <span class="keyword">int</span> entityUserId, <span class="keyword">int</span> postId)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//触发点赞事件</span></span><br><span class="line">    <span class="keyword">if</span> (likeStatus == <span class="number">1</span>) &#123;</span><br><span class="line">        Event event = <span class="keyword">new</span> Event()</span><br><span class="line">                .setTopic(TOPIC_LIKE)</span><br><span class="line">                .setUserId(hostHolder.getUser().getId())</span><br><span class="line">                .setEntityType(entityType)</span><br><span class="line">                .setEntityId(entityId)</span><br><span class="line">                .setEntityUserId(entityUserId)</span><br><span class="line">                .setData(<span class="string">&quot;postId&quot;</span>, postId);</span><br><span class="line">        eventProducer.fireEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改FollowController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EventProducer eventProducer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/follow&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">follow</span><span class="params">(<span class="keyword">int</span> entityType, <span class="keyword">int</span> entityId)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//触发关注事件</span></span><br><span class="line">    Event event = <span class="keyword">new</span> Event()</span><br><span class="line">            .setTopic(TOPIC_FOLLOW)</span><br><span class="line">            .setUserId(hostHolder.getUser().getId())</span><br><span class="line">            .setEntityType(entityType)</span><br><span class="line">            .setEntityId(entityId)</span><br><span class="line">            .setEntityUserId(entityId);</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改ServiceLogAspect：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;pointcut()&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (attributes == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="显示系统通知"><a href="#显示系统通知" class="headerlink" title="显示系统通知"></a>显示系统通知</h4><p>在MessageMapper中增加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询某个主题下最新的通知</span></span><br><span class="line"><span class="function">Message <span class="title">selectLatestNotice</span><span class="params">(<span class="keyword">int</span> userId, String topic)</span></span>;</span><br><span class="line"><span class="comment">//查询某个主题所包含的通知数量</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">selectNoticeCount</span><span class="params">(<span class="keyword">int</span> userId, String topic)</span></span>;</span><br><span class="line"><span class="comment">//查询未读通知的数量</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">selectNoticeUnreadCount</span><span class="params">(<span class="keyword">int</span> userId, String topic)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在message-mapper.xml中写sql：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectLatestNotice&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Message&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from message</span><br><span class="line">    where id in (</span><br><span class="line">        select max(id) from message</span><br><span class="line">        where status != 2</span><br><span class="line">        and from_id = 1</span><br><span class="line">        and to_id = #&#123;userId&#125;</span><br><span class="line">        and conversation_id = #&#123;topic&#125;</span><br><span class="line">    )</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNoticeCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from message</span><br><span class="line">    where status != 2</span><br><span class="line">    and from_id = 1</span><br><span class="line">    and to_id = #&#123;userId&#125;</span><br><span class="line">    and conversation_id = #&#123;topic&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNoticeUnreadCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">    select count(id) from message</span><br><span class="line">    where status = 0</span><br><span class="line">    and from_id = 1</span><br><span class="line">    and to_id = #&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;topic!=null&quot;</span>&gt;</span></span><br><span class="line">        and conversation_id = #&#123;topic&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改MessageService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">findLatestNotice</span><span class="params">(<span class="keyword">int</span> userId, String topic)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectLatestNotice(userId, topic);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findNoticeCount</span><span class="params">(<span class="keyword">int</span> userId, String topic)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectNoticeCount(userId, topic);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findNoticeUnreadCount</span><span class="params">(<span class="keyword">int</span> userId, String topic)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectNoticeUnreadCount(userId, topic);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在MessageController中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/notice/list&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getNoticeList</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">    User user = hostHolder.getUser();</span><br><span class="line">    <span class="comment">//查询评论类通知</span></span><br><span class="line">    Message message = messageService.findLatestNotice(user.getId(), TOPIC_COMMENT);</span><br><span class="line">    <span class="keyword">if</span> (message != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; messageVO = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        messageVO.put(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">        String content = HtmlUtils.htmlUnescape(message.getContent());</span><br><span class="line">        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">        messageVO.put(<span class="string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityType&quot;</span>, data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityId&quot;</span>, data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;postId&quot;</span>, data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> count = messageService.findNoticeCount(user.getId(), TOPIC_COMMENT);</span><br><span class="line">        messageVO.put(<span class="string">&quot;count&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_COMMENT);</span><br><span class="line">        messageVO.put(<span class="string">&quot;unread&quot;</span>, unread);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;commentNotice&quot;</span>, messageVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询点赞类通知</span></span><br><span class="line">    message = messageService.findLatestNotice(user.getId(), TOPIC_LIKE);</span><br><span class="line">    <span class="keyword">if</span> (message != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; messageVO = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        messageVO.put(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">        String content = HtmlUtils.htmlUnescape(message.getContent());</span><br><span class="line">        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">        messageVO.put(<span class="string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityType&quot;</span>, data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityId&quot;</span>, data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;postId&quot;</span>, data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> count = messageService.findNoticeCount(user.getId(), TOPIC_LIKE);</span><br><span class="line">        messageVO.put(<span class="string">&quot;count&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_LIKE);</span><br><span class="line">        messageVO.put(<span class="string">&quot;unread&quot;</span>, unread);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;likeNotice&quot;</span>, messageVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询关注类通知</span></span><br><span class="line">    message = messageService.findLatestNotice(user.getId(), TOPIC_FOLLOW);</span><br><span class="line">    <span class="keyword">if</span> (message != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; messageVO = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        messageVO.put(<span class="string">&quot;message&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">        String content = HtmlUtils.htmlUnescape(message.getContent());</span><br><span class="line">        Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">        messageVO.put(<span class="string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityType&quot;</span>, data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">        messageVO.put(<span class="string">&quot;entityId&quot;</span>, data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> count = messageService.findNoticeCount(user.getId(), TOPIC_FOLLOW);</span><br><span class="line">        messageVO.put(<span class="string">&quot;count&quot;</span>, count);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_FOLLOW);</span><br><span class="line">        messageVO.put(<span class="string">&quot;unread&quot;</span>, unread);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;followNotice&quot;</span>, messageVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询未读消息数量</span></span><br><span class="line">    <span class="keyword">int</span> letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), <span class="keyword">null</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;letterUnreadCount&quot;</span>, letterUnreadCount);</span><br><span class="line">    <span class="keyword">int</span> noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), <span class="keyword">null</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;noticeUnreadCount&quot;</span>, noticeUnreadCount);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/notice&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="开发通知详情"><a href="#开发通知详情" class="headerlink" title="开发通知详情"></a>开发通知详情</h4><p>在MessageMapper中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询某个主题所包含的通知列表</span></span><br><span class="line"><span class="function">List&lt;Message&gt; <span class="title">selectNotices</span><span class="params">(<span class="keyword">int</span> userId, String topic, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在message-mapper.xml中添加sql：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNotices&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Message&quot;</span>&gt;</span></span><br><span class="line">    select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    from message</span><br><span class="line">    where status != 2</span><br><span class="line">    and from_id = 1</span><br><span class="line">    and to_id = #&#123;userId&#125;</span><br><span class="line">    and conversation_id = #&#123;topic&#125;</span><br><span class="line">    order by create_time desc</span><br><span class="line">    limit #&#123;offset&#125;, #&#123;limit&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在MessageService中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Message&gt; <span class="title">findNotices</span><span class="params">(<span class="keyword">int</span> userId, String topic, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> messageMapper.selectNotices(userId, topic, offset, limit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在MessageController中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通知详情</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/notice/detail/&#123;topic&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getNoticeDetail</span><span class="params">(<span class="meta">@PathVariable(&quot;topic&quot;)</span> String topic, Page page, Model model)</span> </span>&#123;</span><br><span class="line">    User user = hostHolder.getUser();</span><br><span class="line">    page.setLimit(<span class="number">5</span>);</span><br><span class="line">    page.setPath(<span class="string">&quot;/notice/detail/&quot;</span> + topic);</span><br><span class="line">    page.setRows(messageService.findNoticeCount(user.getId(), topic));</span><br><span class="line"></span><br><span class="line">    List&lt;Message&gt; noticeList = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; noticeVoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (noticeList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Message notice : noticeList) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            <span class="comment">//通知</span></span><br><span class="line">            map.put(<span class="string">&quot;notice&quot;</span>, notice);</span><br><span class="line">            <span class="comment">//内容</span></span><br><span class="line">            String content = HtmlUtils.htmlUnescape(notice.getContent());</span><br><span class="line">            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);</span><br><span class="line">            map.put(<span class="string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="string">&quot;userId&quot;</span>)));</span><br><span class="line">            map.put(<span class="string">&quot;entityType&quot;</span>, data.get(<span class="string">&quot;entityType&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;entityId&quot;</span>, data.get(<span class="string">&quot;entityId&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;postId&quot;</span>, data.get(<span class="string">&quot;postId&quot;</span>));</span><br><span class="line">            <span class="comment">//通知作者</span></span><br><span class="line">            map.put(<span class="string">&quot;fromUser&quot;</span>, userService.findUserById(notice.getFromId()));</span><br><span class="line"></span><br><span class="line">            noticeVoList.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">&quot;notices&quot;</span>, noticeVoList);</span><br><span class="line">    <span class="comment">//设置已读</span></span><br><span class="line">    List&lt;Integer&gt; ids = getLetterIds(noticeList);</span><br><span class="line">    <span class="keyword">if</span> (!ids.isEmpty()) &#123;</span><br><span class="line">        messageService.readMessage(ids);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/site/notice-detail&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="页面头部显示未读消息总数"><a href="#页面头部显示未读消息总数" class="headerlink" title="页面头部显示未读消息总数"></a>页面头部显示未读消息总数</h4><p>在controller.interceptor包下创建MessageInterceptor拦截器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        User user = hostHolder.getUser();</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span> &amp;&amp; modelAndView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">int</span> noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), <span class="keyword">null</span>);</span><br><span class="line">            modelAndView.addObject(<span class="string">&quot;allUnreadCount&quot;</span>, letterUnreadCount + noticeUnreadCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改WebMvcConfig：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MessageInterceptor messageInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    registry.addInterceptor(messageInterceptor)</span><br><span class="line">            .excludePathPatterns(<span class="string">&quot;/**/*.css&quot;</span>, <span class="string">&quot;/**/*.js&quot;</span>, <span class="string">&quot;/**/*.png&quot;</span>, <span class="string">&quot;/**/*.jpg&quot;</span>, <span class="string">&quot;/**/*.jpeg&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="22-Elasticsearch开发社区搜索功能"><a href="#22-Elasticsearch开发社区搜索功能" class="headerlink" title="22. Elasticsearch开发社区搜索功能"></a>22. Elasticsearch开发社区搜索功能</h3><p>查看当前Springboot支持的elasticsearch版本：打开pom.xml，按住control点击parent标签下的org.springframework.boot，再次以相同方式点击新打开的父pom。本项目默认es版本为7.12.1</p>
<p>在官网<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases%E4%B8%8B%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%89%88%E6%9C%AC">https://www.elastic.co/cn/downloads/past-releases下载对应版本</a></p>
<p>解压，打开config\elasticsearch.yml进行配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: nowcoder</span><br><span class="line">path.data: d:\work\data\elasticsearch\data</span><br><span class="line">path.logs: d:\work\data\elasticsearch\logs</span><br></pre></td></tr></table></figure>

<p>把bin目录E:\elasticsearch-7.12.1\bin添加到环境变量Path中</p>
<p>在github搜索elasticsearch ik安装对应版本中文分词插件</p>
<p>在elasticsearch安装目录plugins下新建文件夹ik，将下载的插件解压缩到ik文件夹下</p>
<p>在<a target="_blank" rel="noopener" href="https://www.postman.com下载postman(模拟web客户端)/">https://www.postman.com下载postman（模拟web客户端）</a></p>
<h4 id="命令行使用Elasticsearch"><a href="#命令行使用Elasticsearch" class="headerlink" title="命令行使用Elasticsearch"></a>命令行使用Elasticsearch</h4><p>打开bin\elasticsearch.bat</p>
<p>打开新命令行窗口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET &quot;localhost:9200&#x2F;_cat&#x2F;health?v&quot;		&#x2F;&#x2F;查看集群状况</span><br><span class="line">curl -X GET &quot;localhost:9200&#x2F;_cat&#x2F;nodes?v&quot;		&#x2F;&#x2F;查看节点状况</span><br><span class="line">curl -X GET &quot;localhost:9200&#x2F;_cat&#x2F;indices?v&quot;		&#x2F;&#x2F;查看所有索引</span><br><span class="line">curl -X PUT &quot;localhost:9200&#x2F;test&quot;		&#x2F;&#x2F;添加索引test</span><br><span class="line">curl -X DELETE &quot;localhost:9200&#x2F;test&quot;		&#x2F;&#x2F;删除索引test</span><br></pre></td></tr></table></figure>

<h4 id="Postman操作Elasticsearch"><a href="#Postman操作Elasticsearch" class="headerlink" title="Postman操作Elasticsearch"></a>Postman操作Elasticsearch</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">localhost:9200&#x2F;_cat&#x2F;indices?v		&#x2F;&#x2F;选择GET请求，查看所有索引</span><br><span class="line">localhost:9200&#x2F;test		&#x2F;&#x2F;选择PUT请求，添加索引test</span><br><span class="line">localhost:9200&#x2F;test		&#x2F;&#x2F;选择DELETE请求，删除索引test</span><br></pre></td></tr></table></figure>

<p>插入、读取、删除数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">localhost:9200&#x2F;test&#x2F;_doc&#x2F;1		&#x2F;&#x2F;选择PUT请求，在test索引中添加数据</span><br><span class="line">点击Body标签，选择row和JSON(application&#x2F;json)选项，编写json数据：</span><br><span class="line">&#123;</span><br><span class="line">	&quot;title&quot;:&quot;Hello&quot;,</span><br><span class="line">	&quot;content&quot;:&quot;How are you&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">localhost:9200&#x2F;test&#x2F;_doc&#x2F;1		&#x2F;&#x2F;选择GET请求，查看test索引中id为1的数据</span><br><span class="line"></span><br><span class="line">localhost:9200&#x2F;test&#x2F;_doc&#x2F;1		&#x2F;&#x2F;选择DELETE请求，删除test索引中id为1的数据</span><br><span class="line"></span><br><span class="line">localhost:9200&#x2F;test&#x2F;_search		&#x2F;&#x2F;选择GET请求，查看所有test索引中的数据</span><br><span class="line"></span><br><span class="line">localhost:9200&#x2F;test&#x2F;_search?q&#x3D;title:互联网		&#x2F;&#x2F;选择GET请求，查询test索引中title中包含&quot;互联网&quot;的数据</span><br><span class="line"></span><br><span class="line">localhost:9200&#x2F;test&#x2F;_search?q&#x3D;content:运营实习		&#x2F;&#x2F;选择GET请求，查询test索引中content中包含&quot;运营实习&quot;的数据</span><br><span class="line"></span><br><span class="line">localhost:9200&#x2F;test&#x2F;_search		&#x2F;&#x2F;选择GET请求，查询test索引中的数据</span><br><span class="line">点击Body标签，选择row和JSON(application&#x2F;json)选项，编写json数据：</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;multi_match&quot;:&#123;</span><br><span class="line">			&quot;query&quot;:&quot;互联网&quot;,</span><br><span class="line">			&quot;fields&quot;:[&quot;title&quot;,&quot;content&quot;]		&#x2F;&#x2F;查询在title或content中包含&quot;互联网&quot;的数据</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Spring整合Elasticsearch"><a href="#Spring整合Elasticsearch" class="headerlink" title="Spring整合Elasticsearch"></a>Spring整合Elasticsearch</h4><p>在pom.xml中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置application.properties（老版方法，新版已废弃）：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ElasticsearchProperties</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-name</span>=<span class="string">nowcoder</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-nodes</span>=<span class="string">localhost:9300</span></span><br></pre></td></tr></table></figure>

<p>新版方法：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ElasticsearchRepositories</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.repositories.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>Elasticsearch和redis都基于Netty，需要解决冲突问题</p>
<p>修改CommunityApplication：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//解决netty启动冲突问题</span></span><br><span class="line">    <span class="comment">//Netty4Utils.setAvailableProcessors()</span></span><br><span class="line">    System.setProperty(<span class="string">&quot;es.set.netty.runtime.available.processors&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在DiscussPost实体类上添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document(indexName = &quot;discusspost&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscussPost</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> status;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Date)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Integer)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> commentCount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Double)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> score;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在dao包下创建elasticsearch.DiscussPostRepository接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="comment">//泛型中声明实体类和主键类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DiscussPostRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">DiscussPost</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写测试类ElasticsearchTests：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostMapper discussMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostRepository discussRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//新版不能用，会报错</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate elasticTemplate;      <span class="comment">//不能写成ElasticsearchTemplate</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span> </span>&#123;      <span class="comment">//一次插入一条数据</span></span><br><span class="line">        discussRepository.save(discussMapper.selectDiscussPostById(<span class="number">241</span>));</span><br><span class="line">        discussRepository.save(discussMapper.selectDiscussPostById(<span class="number">242</span>));</span><br><span class="line">        discussRepository.save(discussMapper.selectDiscussPostById(<span class="number">243</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsertList</span><span class="params">()</span> </span>&#123;      <span class="comment">//一次插入多条数据</span></span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">101</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">102</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">103</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">111</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">112</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">131</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">132</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">133</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        discussRepository.saveAll(discussMapper.selectDiscussPosts(<span class="number">134</span>, <span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> </span>&#123;      <span class="comment">//修改数据</span></span><br><span class="line">        DiscussPost post = discussMapper.selectDiscussPostById(<span class="number">231</span>);</span><br><span class="line">        post.setContent(<span class="string">&quot;我是新人，使劲灌水&quot;</span>);</span><br><span class="line">        discussRepository.save(post);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> </span>&#123;      <span class="comment">//删除数据</span></span><br><span class="line">        <span class="comment">//discussRepository.deleteById(231);</span></span><br><span class="line">        discussRepository.deleteAll();      <span class="comment">//删除所有数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearchByRepository</span><span class="params">()</span> </span>&#123;      <span class="comment">//搜索数据</span></span><br><span class="line">        NativeSearchQuery searchQuery = <span class="keyword">new</span> NativeSearchQueryBuilder()</span><br><span class="line">                .withQuery(QueryBuilders.multiMatchQuery(<span class="string">&quot;互联网寒冬&quot;</span>, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>))</span><br><span class="line">                .withSort(SortBuilders.fieldSort(<span class="string">&quot;type&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .withSort(SortBuilders.fieldSort(<span class="string">&quot;score&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .withSort(SortBuilders.fieldSort(<span class="string">&quot;createTime&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .withPageable(PageRequest.of(<span class="number">0</span>, <span class="number">10</span>))</span><br><span class="line">                .withHighlightFields(</span><br><span class="line">                        <span class="keyword">new</span> HighlightBuilder.Field(<span class="string">&quot;title&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> HighlightBuilder.Field(<span class="string">&quot;content&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>)</span><br><span class="line">                ).build();</span><br><span class="line">        SearchHits&lt;DiscussPost&gt; search = elasticTemplate.search(searchQuery, DiscussPost.class);</span><br><span class="line">        List&lt;SearchHit&lt;DiscussPost&gt;&gt; searchHits = search.getSearchHits();       <span class="comment">//得到查询结果</span></span><br><span class="line">        List&lt;DiscussPost&gt; discussPosts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit&lt;DiscussPost&gt; searchHit : searchHits) &#123;</span><br><span class="line">            <span class="comment">// 高亮的内容</span></span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; highLightFields = searchHit.getHighlightFields();</span><br><span class="line">            <span class="comment">// 将高亮的内容填充到content中</span></span><br><span class="line">            searchHit.getContent().setTitle(highLightFields.get(<span class="string">&quot;title&quot;</span>) == <span class="keyword">null</span> ? searchHit.getContent().getTitle() : highLightFields.get(<span class="string">&quot;title&quot;</span>).get(<span class="number">0</span>));</span><br><span class="line">            searchHit.getContent().setTitle(highLightFields.get(<span class="string">&quot;content&quot;</span>) == <span class="keyword">null</span> ? searchHit.getContent().getContent() : highLightFields.get(<span class="string">&quot;content&quot;</span>).get(<span class="number">0</span>));</span><br><span class="line">            <span class="comment">// 放到实体类中</span></span><br><span class="line">            discussPosts.add(searchHit.getContent());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(search.getTotalHits());</span><br><span class="line">        System.out.println(discussPosts.size());</span><br><span class="line">        <span class="keyword">for</span>(DiscussPost discussPost : discussPosts)&#123;</span><br><span class="line">            System.out.println(discussPost);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="搜索服务"><a href="#搜索服务" class="headerlink" title="搜索服务"></a>搜索服务</h4><p>修改discusspost-mapper.xml，设置keyProperty：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertDiscussPost&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;DiscussPost&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在service包下新建ElasticsearchService类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostRepository discussRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchRestTemplate elasticTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveDiscussPost</span><span class="params">(DiscussPost post)</span> </span>&#123;</span><br><span class="line">        discussRepository.save(post);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteDiscussPost</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        discussRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">searchDiscussPost</span><span class="params">(String keyword, <span class="keyword">int</span> current, <span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        NativeSearchQuery searchQuery = <span class="keyword">new</span> NativeSearchQueryBuilder()</span><br><span class="line">                .withQuery(QueryBuilders.multiMatchQuery(keyword, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>))</span><br><span class="line">                .withSort(SortBuilders.fieldSort(<span class="string">&quot;type&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .withSort(SortBuilders.fieldSort(<span class="string">&quot;score&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .withSort(SortBuilders.fieldSort(<span class="string">&quot;createTime&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .withPageable(PageRequest.of(current, limit))</span><br><span class="line">                .withHighlightFields(</span><br><span class="line">                        <span class="keyword">new</span> HighlightBuilder.Field(<span class="string">&quot;title&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> HighlightBuilder.Field(<span class="string">&quot;content&quot;</span>).preTags(<span class="string">&quot;&lt;em&gt;&quot;</span>).postTags(<span class="string">&quot;&lt;/em&gt;&quot;</span>)</span><br><span class="line">                ).build();</span><br><span class="line">        SearchHits&lt;DiscussPost&gt; search = elasticTemplate.search(searchQuery, DiscussPost.class);</span><br><span class="line">        List&lt;SearchHit&lt;DiscussPost&gt;&gt; searchHits = search.getSearchHits();       <span class="comment">//得到查询结果</span></span><br><span class="line">        List&lt;DiscussPost&gt; discussPosts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit&lt;DiscussPost&gt; searchHit : searchHits) &#123;</span><br><span class="line">            <span class="comment">// 高亮的内容</span></span><br><span class="line">            Map&lt;String, List&lt;String&gt;&gt; highLightFields = searchHit.getHighlightFields();</span><br><span class="line">            <span class="comment">// 将高亮的内容填充到content中</span></span><br><span class="line">            searchHit.getContent().setTitle(highLightFields.get(<span class="string">&quot;title&quot;</span>) == <span class="keyword">null</span> ? searchHit.getContent().getTitle() : highLightFields.get(<span class="string">&quot;title&quot;</span>).get(<span class="number">0</span>));</span><br><span class="line">            searchHit.getContent().setTitle(highLightFields.get(<span class="string">&quot;content&quot;</span>) == <span class="keyword">null</span> ? searchHit.getContent().getContent() : highLightFields.get(<span class="string">&quot;content&quot;</span>).get(<span class="number">0</span>));</span><br><span class="line">            <span class="comment">// 放到实体类中</span></span><br><span class="line">            discussPosts.add(searchHit.getContent());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Object&gt; res = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        res.add((<span class="keyword">int</span>)search.getTotalHits());</span><br><span class="line">        res.add(discussPosts);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="发布事件"><a href="#发布事件" class="headerlink" title="发布事件"></a>发布事件</h4><p>发布帖子、增加评论：将帖子异步提交到Elasticsearch服务器</p>
<p>在CommunityConstant中添加常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String TOPIC_PUBLISH = <span class="string">&quot;publish&quot;</span>;       <span class="comment">//主题类型：发帖</span></span><br></pre></td></tr></table></figure>

<p>修改DiscussPostController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EventProducer eventProducer;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/add&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">addDiscussPost</span><span class="params">(String title, String content)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//触发发帖事件（Elasticsearch）</span></span><br><span class="line">    Event event = <span class="keyword">new</span> Event()</span><br><span class="line">            .setTopic(TOPIC_PUBLISH)</span><br><span class="line">            .setUserId(user.getId())</span><br><span class="line">            .setEntityType(ENTITY_TYPE_POST)</span><br><span class="line">            .setEntityId(post.getId());</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改CommentController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">addComment</span><span class="params">(<span class="meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="keyword">int</span> discussPostId, Comment comment)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST) &#123;</span><br><span class="line">        <span class="comment">//触发发帖事件（Elasticsearch）</span></span><br><span class="line">        event = <span class="keyword">new</span> Event()</span><br><span class="line">                .setTopic(TOPIC_PUBLISH)</span><br><span class="line">                .setUserId(comment.getUserId())</span><br><span class="line">                .setEntityType(ENTITY_TYPE_POST)</span><br><span class="line">                .setEntityId(discussPostId);</span><br><span class="line">        eventProducer.fireEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在EventConsumer中添加新方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscussPostService discussPostService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ElasticsearchService elasticsearchService;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//消费发帖事件</span></span><br><span class="line"><span class="meta">@KafkaListener(topics = &#123;TOPIC_PUBLISH&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlePublishMessage</span><span class="params">(ConsumerRecord record)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (record == <span class="keyword">null</span> || record.value() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;消息内容为空！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Event event = JSONObject.parseObject(record.value().toString(), Event.class);</span><br><span class="line">    <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;消息格式错误！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DiscussPost post = discussPostService.findDiscussPostById(event.getEntityId());</span><br><span class="line">    elasticsearchService.saveDiscussPost(post);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建SearchController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchController</span> <span class="keyword">implements</span> <span class="title">CommunityConstant</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchService elasticsearchService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LikeService likeService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//地址：/search?keyword=xxx</span></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/search&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">search</span><span class="params">(String keyword, Page page, Model model)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//查找帖子</span></span><br><span class="line">        List&lt;Object&gt; list = elasticsearchService.searchDiscussPost(keyword, page.getCurrent() - <span class="number">1</span>, page.getLimit());</span><br><span class="line">        <span class="comment">//聚合数据</span></span><br><span class="line">        List&lt;DiscussPost&gt; posts = (List&lt;DiscussPost&gt;) list.get(<span class="number">1</span>);</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; discussPosts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (posts != <span class="keyword">null</span> &amp;&amp; posts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (DiscussPost post : posts) &#123;</span><br><span class="line">                Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                map.put(<span class="string">&quot;post&quot;</span>, post);      <span class="comment">//帖子</span></span><br><span class="line">                map.put(<span class="string">&quot;user&quot;</span>, userService.findUserById(post.getUserId()));        <span class="comment">//作者</span></span><br><span class="line">                map.put(<span class="string">&quot;likeCount&quot;</span>, likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId()));      <span class="comment">//点赞数量</span></span><br><span class="line">                discussPosts.add(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;discussPosts&quot;</span>, discussPosts);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;keyWord&quot;</span>, keyword);</span><br><span class="line">        <span class="comment">//分页信息</span></span><br><span class="line">        page.setPath(<span class="string">&quot;/search?keyword=&quot;</span> + keyword);</span><br><span class="line">        page.setRows(list.get(<span class="number">0</span>) == <span class="keyword">null</span> ? <span class="number">0</span> : (<span class="keyword">int</span>)list.get(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/search&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="23-Spring-Security权限控制"><a href="#23-Spring-Security权限控制" class="headerlink" title="23. Spring Security权限控制"></a>23. Spring Security权限控制</h3><p>登录检查：废弃拦截器登录检查方式</p>
<p>授权配置：分配访问权限（普通用户、版主、管理员）</p>
<p>认证方案：绕过Security认证，采用原来的认证方案</p>
<p>CSRF配置：防止CSRF攻击，以及表单、AJAX相关配置</p>
<p>在pom.xml中引入Spring Security依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>打开WebMvcConfig，把LoginRequiredInterceptor相关内容删除</p>
<p>在CommunityConstant中增加常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String AUTHORITY_USER = <span class="string">&quot;user&quot;</span>;     <span class="comment">//权限：普通用户</span></span><br><span class="line">String AUTHORITY_ADMIN = <span class="string">&quot;admin&quot;</span>;     <span class="comment">//权限：管理员</span></span><br><span class="line">String AUTHORITY_MODERATOR = <span class="string">&quot;moderator&quot;</span>;     <span class="comment">//权限：版主</span></span><br></pre></td></tr></table></figure>

<p>在config包下新建SecurityConfig：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title">CommunityConstant</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/resources/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//授权</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(</span><br><span class="line">                        <span class="string">&quot;/user/setting&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/upload&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/discuss/add&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/comment/add/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/letter/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/notice/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/like&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/follow&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/unfollow&quot;</span></span><br><span class="line">                )</span><br><span class="line">                .hasAnyAuthority(</span><br><span class="line">                        AUTHORITY_USER,</span><br><span class="line">                        AUTHORITY_ADMIN,</span><br><span class="line">                        AUTHORITY_MODERATOR</span><br><span class="line">                )</span><br><span class="line">                .anyRequest().permitAll()</span><br><span class="line">                .and().csrf().disable();        <span class="comment">//取消生成csrf凭证</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//权限不够时的处理</span></span><br><span class="line">        http.exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint(<span class="keyword">new</span> AuthenticationEntryPoint() &#123;</span><br><span class="line">                    <span class="comment">//没有登录时</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">                        String xRequestedWith = request.getHeader(<span class="string">&quot;x-requested-with&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith)) &#123;      <span class="comment">//异步请求</span></span><br><span class="line">                            response.setContentType(<span class="string">&quot;application/plain;charset=utf-8&quot;</span>);</span><br><span class="line">                            PrintWriter writer = response.getWriter();</span><br><span class="line">                            writer.write(CommunityUtil.getJSONString(<span class="number">403</span>, <span class="string">&quot;您还没有登录！&quot;</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            response.sendRedirect(request.getContextPath() + <span class="string">&quot;/login&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .accessDeniedHandler(<span class="keyword">new</span> AccessDeniedHandler() &#123;</span><br><span class="line">                    <span class="comment">//权限不足时（已登录）</span></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">                        String xRequestedWith = request.getHeader(<span class="string">&quot;x-requested-with&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith)) &#123;      <span class="comment">//异步请求</span></span><br><span class="line">                            response.setContentType(<span class="string">&quot;application/plain;charset=utf-8&quot;</span>);</span><br><span class="line">                            PrintWriter writer = response.getWriter();</span><br><span class="line">                            writer.write(CommunityUtil.getJSONString(<span class="number">403</span>, <span class="string">&quot;您没有访问此功能的权限！&quot;</span>));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            response.sendRedirect(request.getContextPath() + <span class="string">&quot;/denied&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Security底层默认拦截/logout请求，需要覆盖它才能执行自己的逻辑</span></span><br><span class="line">        http.logout().logoutUrl(<span class="string">&quot;/securitylogout&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在HomeController中增加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/denied&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDeniedPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/error/404&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在UserService中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities(<span class="keyword">int</span> userId) &#123;</span><br><span class="line">    User user = <span class="keyword">this</span>.findUserById(userId);</span><br><span class="line">    List&lt;GrantedAuthority&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="keyword">new</span> GrantedAuthority() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getAuthority</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (user.getType()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> AUTHORITY_ADMIN;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">return</span> AUTHORITY_MODERATOR;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> AUTHORITY_USER;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改LoginTicketInterceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="comment">//构建用户认证结果并存入SecurityContext，以便于Security进行授权</span></span><br><span class="line">        Authentication authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">                user, user.getPassword(), userService.getAuthorities(user.getId()));</span><br><span class="line">        SecurityContextHolder.setContext(<span class="keyword">new</span> SecurityContextImpl(authentication));</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    SecurityContextHolder.clearContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改LoginController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/logout&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">logout</span><span class="params">(<span class="meta">@CookieValue(&quot;ticket&quot;)</span> String ticket)</span> </span>&#123;      <span class="comment">//spring注入cookie值</span></span><br><span class="line">    ...</span><br><span class="line">    SecurityContextHolder.clearContext();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring Security自动在form上增加隐藏域” _csrf “，但异步请求必须手动配置</p>
<h4 id="置顶、加精、删除功能"><a href="#置顶、加精、删除功能" class="headerlink" title="置顶、加精、删除功能"></a>置顶、加精、删除功能</h4><p>版主可以看到、执行“置顶”、“加精”操作</p>
<p>版主可以看到、执行“删除”操作</p>
<p>普通用户看不到任何按钮，无法执行操作</p>
<p>在DiscussPostMapper中添加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">updateType</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">int</span> type)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">updateStatus</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">int</span> status)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在discusspost-mapper.xml中增加sql：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateType&quot;</span>&gt;</span></span><br><span class="line">    update discuss_post set type = #&#123;type&#125; where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateStatus&quot;</span>&gt;</span></span><br><span class="line">    update discuss_post set status = #&#123;status&#125; where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改DiscussPostService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateType</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> discussPostMapper.updateType(id, type);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateStatus</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> discussPostMapper.updateStatus(id, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在CommunityConstant中添加常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String TOPIC_DELETE = <span class="string">&quot;delete&quot;</span>;       <span class="comment">//主题类型：删帖</span></span><br></pre></td></tr></table></figure>

<p>修改DiscussPostController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//置顶</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/top&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">setTop</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    discussPostService.updateType(id, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//触发发帖事件（Elasticsearch）</span></span><br><span class="line">    User user = hostHolder.getUser();</span><br><span class="line">    Event event = <span class="keyword">new</span> Event()</span><br><span class="line">            .setTopic(TOPIC_PUBLISH)</span><br><span class="line">            .setUserId(user.getId())</span><br><span class="line">            .setEntityType(ENTITY_TYPE_POST)</span><br><span class="line">            .setEntityId(id);</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加精</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/wonderful&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">setWonderful</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    discussPostService.updateStatus(id, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//触发发帖事件（Elasticsearch）</span></span><br><span class="line">    User user = hostHolder.getUser();</span><br><span class="line">    Event event = <span class="keyword">new</span> Event()</span><br><span class="line">            .setTopic(TOPIC_PUBLISH)</span><br><span class="line">            .setUserId(user.getId())</span><br><span class="line">            .setEntityType(ENTITY_TYPE_POST)</span><br><span class="line">            .setEntityId(id);</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//拉黑（删除）</span></span><br><span class="line"><span class="meta">@RequestMapping(path = &quot;/delete&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">setDelete</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    discussPostService.updateStatus(id, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">//触发删帖事件（Elasticsearch）</span></span><br><span class="line">    User user = hostHolder.getUser();</span><br><span class="line">    Event event = <span class="keyword">new</span> Event()</span><br><span class="line">            .setTopic(TOPIC_DELETE)</span><br><span class="line">            .setUserId(user.getId())</span><br><span class="line">            .setEntityType(ENTITY_TYPE_POST)</span><br><span class="line">            .setEntityId(id);</span><br><span class="line">    eventProducer.fireEvent(event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在EventConsumer中增加方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//消费删帖事件</span></span><br><span class="line"><span class="meta">@KafkaListener(topics = &#123;TOPIC_DELETE&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDeleteMessage</span><span class="params">(ConsumerRecord record)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (record == <span class="keyword">null</span> || record.value() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;消息内容为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Event event = JSONObject.parseObject(record.value().toString(), Event.class);</span><br><span class="line">    <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;消息格式错误！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elasticsearchService.deleteDiscussPost(event.getEntityId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="24-Redis高级数据类型"><a href="#24-Redis高级数据类型" class="headerlink" title="24. Redis高级数据类型"></a>24. Redis高级数据类型</h3><h4 id="网站数据统计"><a href="#网站数据统计" class="headerlink" title="网站数据统计"></a>网站数据统计</h4><p>UV（Unique Visitor）：独立访客，通过用户ip去重统计，每次访问都要进行统计。使用HyperLogLog</p>
<p>DAU（Daily Active User）：日活跃用户，通过用户id去重统计，访问过一次则认为活跃，使用Bitmap</p>
<p>修改RedisKeyUtil：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_UV = <span class="string">&quot;uv&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_DAU = <span class="string">&quot;dau&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//单日UV</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUVKey</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_UV + SPLIT + date;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//区间UV</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUVKey</span><span class="params">(String startDate, String endDate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_UV + SPLIT + startDate + SPLIT + endDate;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//单日活跃用户</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDAUKey</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_DAU + SPLIT + date;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//区间活跃用户</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDAUKey</span><span class="params">(String startDate, String endDate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX_DAU + SPLIT + startDate + SPLIT + endDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建DataService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SimpleDateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyyMMdd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将指定ip计入uv</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordUV</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">        String redisKey = RedisKeyUtil.getUVKey(df.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        redisTemplate.opsForHyperLogLog().add(redisKey, ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计指定日期范围内的uv</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">calculateUV</span><span class="params">(Date start, Date end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start == <span class="keyword">null</span> || end == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;参数不能为空！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取该日期范围内的所有key</span></span><br><span class="line">        List&lt;String&gt; keyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line">        calendar.setTime(start);</span><br><span class="line">        <span class="keyword">while</span> (calendar.getTime().after(end)) &#123;     <span class="comment">//不超过end，包含end</span></span><br><span class="line">            String key = RedisKeyUtil.getUVKey(df.format(calendar.getTime()));</span><br><span class="line">            keyList.add(key);</span><br><span class="line">            calendar.add(Calendar.DATE, <span class="number">1</span>);     <span class="comment">//每次增加一天</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//合并数据</span></span><br><span class="line">        String redisKey = RedisKeyUtil.getUVKey(df.format(start), df.format(end));</span><br><span class="line">        redisTemplate.opsForHyperLogLog().union(redisKey, keyList.toArray());</span><br><span class="line">        <span class="comment">//返回统计结果</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().size(redisKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将指定用户计入DAU</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordDAU</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        String redisKey = RedisKeyUtil.getDAUKey(df.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        redisTemplate.opsForValue().setBit(redisKey, userId, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计指定日期范围内的DAU</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">calculateDAU</span><span class="params">(Date start, Date end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start == <span class="keyword">null</span> || end == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;参数不能为空！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取该日期范围内的所有key</span></span><br><span class="line">        List&lt;<span class="keyword">byte</span>[]&gt; keyList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line">        calendar.setTime(start);</span><br><span class="line">        <span class="keyword">while</span> (calendar.getTime().after(end)) &#123;     <span class="comment">//不超过end，包含end</span></span><br><span class="line">            String key = RedisKeyUtil.getDAUKey(df.format(calendar.getTime()));</span><br><span class="line">            keyList.add(key.getBytes());</span><br><span class="line">            calendar.add(Calendar.DATE, <span class="number">1</span>);     <span class="comment">//每次增加一天</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//进行or运算</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">long</span>) redisTemplate.execute(<span class="keyword">new</span> RedisCallback() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span><br><span class="line">                String redisKey = RedisKeyUtil.getDAUKey(df.format(start), df.format(end));</span><br><span class="line">                connection.bitOp(RedisStringCommands.BitOperation.OR,</span><br><span class="line">                        redisKey.getBytes(), keyList.toArray(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>][<span class="number">0</span>]));</span><br><span class="line">                <span class="keyword">return</span> connection.bitCount(redisKey.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建拦截器DataInterceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataService dataService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HostHolder hostHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//统计UV</span></span><br><span class="line">        String ip = request.getRemoteHost();</span><br><span class="line">        dataService.recordUV(ip);</span><br><span class="line">        <span class="comment">//统计DAU</span></span><br><span class="line">        User user = hostHolder.getUser();</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">            dataService.recordDAU(user.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改WebMvcConfig：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DataInterceptor dataInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    registry.addInterceptor(dataInterceptor)</span><br><span class="line">            .excludePathPatterns(<span class="string">&quot;/**/*.css&quot;</span>, <span class="string">&quot;/**/*.js&quot;</span>, <span class="string">&quot;/**/*.png&quot;</span>, <span class="string">&quot;/**/*.jpg&quot;</span>, <span class="string">&quot;/**/*.jpeg&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建DataController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataService dataService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//访问统计页面</span></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/data&quot;, method = &#123;RequestMethod.GET, RequestMethod.POST&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDataPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/admin/data&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计网站UV</span></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/data/uv&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUV</span><span class="params">(<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span>Date start,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span>Date end, Model model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> uv = dataService.calculateUV(start, end);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;uvResult&quot;</span>, uv);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;uvStartDate&quot;</span>, start);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;uvEndDate&quot;</span>, end);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/admin/data&quot;</span>;      <span class="comment">//或者写&quot;forward:/data&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计活跃用户</span></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/data/dau&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDAU</span><span class="params">(<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span>Date start,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span>Date end, Model model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> dau = dataService.calculateDAU(start, end);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;dauResult&quot;</span>, dau);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;dauStartDate&quot;</span>, start);</span><br><span class="line">        model.addAttribute(<span class="string">&quot;dauEndDate&quot;</span>, end);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/admin/data&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置权限</p>
<h3 id="25-优化网站性能：缓存帖子"><a href="#25-优化网站性能：缓存帖子" class="headerlink" title="25. 优化网站性能：缓存帖子"></a>25. 优化网站性能：缓存帖子</h3><p>本地缓存：将数据缓存在应用服务器上，性能最好（常用缓存工具：Ehcache、Guava、Caffeine等）</p>
<p>分布式缓存：将数据缓存在NoSQL数据库上，跨服务器（常用缓存工具：MemCache、Redis等）</p>
<p>多级缓存：一级缓存（本地缓存）-&gt;二级缓存（分布式缓存）-&gt;DB</p>
<p>在pom.xml中添加caffeine依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>caffeine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在application.properties中添加配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># caffeine</span></span><br><span class="line"><span class="meta">caffeine.posts.max-size</span>=<span class="string">15      #最多缓存15条</span></span><br><span class="line"><span class="meta">caffeine.posts.expire-seconds</span>=<span class="string">180       #保存180秒</span></span><br></pre></td></tr></table></figure>

<p>修改DiscussPostService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DiscussPostService.class);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;caffeine.posts.max-size&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> maxSize;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;caffeine.posts.expire-seconds&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> expireSeconds;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Caffeine核心接口：Cache, LoadingCache, AsyncLoadingCache</span></span><br><span class="line"><span class="comment">//帖子列表缓存</span></span><br><span class="line"><span class="keyword">private</span> LoadingCache&lt;String, List&lt;DiscussPost&gt;&gt; postListCache;</span><br><span class="line"></span><br><span class="line"><span class="comment">//贴子总数缓存</span></span><br><span class="line"><span class="keyword">private</span> LoadingCache&lt;Integer, Integer&gt; postRowsCache;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//初始化帖子列表缓存</span></span><br><span class="line">    postListCache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(maxSize)</span><br><span class="line">            .expireAfterWrite(expireSeconds, TimeUnit.SECONDS)</span><br><span class="line">            .build(<span class="keyword">new</span> CacheLoader&lt;String, List&lt;DiscussPost&gt;&gt;() &#123;</span><br><span class="line">                <span class="comment">//缓存获取数据的逻辑</span></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">List&lt;DiscussPost&gt; <span class="title">load</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (key == <span class="keyword">null</span> || key.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;参数错误！&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    String[] params = key.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (params == <span class="keyword">null</span> || params.length != <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;参数错误！&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">int</span> offset = Integer.valueOf(params[<span class="number">0</span>]);</span><br><span class="line">                    <span class="keyword">int</span> limit = Integer.valueOf(params[<span class="number">1</span>]);</span><br><span class="line">                    <span class="comment">//此处可以添加二级缓存：Redis -&gt; mysql</span></span><br><span class="line">                    logger.debug(<span class="string">&quot;load post list from DB.&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> discussPostMapper.selectDiscussPosts(<span class="number">0</span>, offset, limit);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="comment">//初始化贴子总数缓存</span></span><br><span class="line">    postRowsCache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(maxSize)</span><br><span class="line">            .expireAfterWrite(expireSeconds, TimeUnit.SECONDS)</span><br><span class="line">            .build(<span class="keyword">new</span> CacheLoader&lt;Integer, Integer&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Integer <span class="title">load</span><span class="params">(<span class="meta">@NonNull</span> Integer key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    logger.debug(<span class="string">&quot;load post list from DB.&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> discussPostMapper.selectDiscussPostRows(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;DiscussPost&gt; <span class="title">findDiscussPosts</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (userId == <span class="number">0</span>) &#123;      <span class="comment">//首页查询</span></span><br><span class="line">        <span class="keyword">return</span> postListCache.get(offset + <span class="string">&quot;:&quot;</span> + limit);</span><br><span class="line">    &#125;</span><br><span class="line">    logger.debug(<span class="string">&quot;load post list from DB.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> discussPostMapper.selectDiscussPosts(userId, offset, limit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findDiscussPostRows</span><span class="params">(<span class="keyword">int</span> userId)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (userId == <span class="number">0</span>) &#123;      <span class="comment">//首页查询</span></span><br><span class="line">        <span class="keyword">return</span> postRowsCache.get(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    logger.debug(<span class="string">&quot;load post rows from DB.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> discussPostMapper.selectDiscussPostRows(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h4><p>压力测试工具：JMeter</p>
<p>把DiscussPostService中缓存代码注释掉，测试不用缓存时的性能</p>
<p>解压JMeter安装包，打开bin\jmeter.bat，可以设置语言为中文</p>
<p>右键TestPlan-添加-线程（用户）-线程组</p>
<p>线程组设置线程数（100），循环次数勾选永远，持续时间设置60秒</p>
<p>右键线程组，添加-取样器-HTTP请求，配置Web服务器协议：http，ip：127.0.0.1，端口号8080，HTTP请求方法：GET，路径：/community/index，内容编码：utf-8</p>
<p>右键线程组，添加-定时器-统一随机定时器，设置随机延迟时间1000毫秒</p>
<p>右键线程组，添加-监听器-聚合报告</p>
<p>启动服务，点击绿色三角开始测试</p>
<p>取消缓存代码注释，再次测试观察结果</p>
<h3 id="26-项目发布"><a href="#26-项目发布" class="headerlink" title="26. 项目发布"></a>26. 项目发布</h3><p>Spring Boot Actuator</p>
<p>EndPoints：监控应用的入口，Spring Boot内置了很多端点，也支持自定义端点</p>
<p>监控方式：HTTP或JMX</p>
<p>访问路径：如”/actuator/health”</p>
<p>按需配置暴露的端点（影响性能），对所有端点进行权限控制（保证安全）</p>
<p>在pom.xml中引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置application.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># actuator</span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">*     #配置可用端点</span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.exclude</span>=<span class="string">info,caches       #配置不可用端点</span></span><br></pre></td></tr></table></figure>

<p>自定义端点：</p>
<p>新建actuator包、DatabaseEndPoint类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Endpoint(id = &quot;database&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseEndpoint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DatabaseEndpoint.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReadOperation</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">checkConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                Connection conn = dataSource.getConnection();</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">0</span>, <span class="string">&quot;获取连接成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;获取连接失败:&quot;</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> CommunityUtil.getJSONString(<span class="number">1</span>, <span class="string">&quot;获取连接失败!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置权限</p>
<h4 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h4><p>阿里云ECS：2cpu 4G内存（最低4G），CentOS 7.6</p>
<p>安装Putty操作云服务器</p>
</div><div class="post-copyright"><blockquote><p>Original author: Liu Sai</p><p>Original link: <a href="http://example.com/2021/08/23/社区项目（下）/">http://example.com/2021/08/23/社区项目（下）/</a></p><p>Copyright Notice: Please indicate the source of the reprint (must retain the author's signature and link)</p></blockquote></div><div class="tags"><a href="/tags/%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE/">社区项目</a></div><div class="post-share"><div class="social-share"><span>Share:</span></div></div><div class="post-nav"><a href="/2021/09/11/JVM/" class="pre">JVM</a><a href="/2021/07/09/%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%B8%8A%EF%BC%89/" class="next">社区项目（上）</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE"><span class="toc-text">社区项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#18-Redis%E5%AE%9E%E7%8E%B0%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD"><span class="toc-text">18. Redis实现点赞功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%91%E6%94%B6%E5%88%B0%E7%9A%84%E8%B5%9E"><span class="toc-text">我收到的赞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%B8%AA%E4%BA%BA%E4%B8%BB%E9%A1%B5"><span class="toc-text">用户个人主页</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-Redis%E5%AE%9E%E7%8E%B0%E5%85%B3%E6%B3%A8%E3%80%81%E5%8F%96%E6%B6%88%E5%85%B3%E6%B3%A8"><span class="toc-text">19. Redis实现关注、取消关注</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E5%85%B3%E6%B3%A8%E6%95%B0%E3%80%81%E7%B2%89%E4%B8%9D%E6%95%B0"><span class="toc-text">统计关注数、粉丝数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E6%B3%A8%E5%88%97%E8%A1%A8%E3%80%81%E7%B2%89%E4%B8%9D%E5%88%97%E8%A1%A8"><span class="toc-text">关注列表、粉丝列表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-%E4%BC%98%E5%8C%96%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97"><span class="toc-text">20. 优化登录模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Redis%E5%AD%98%E5%82%A8%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">使用Redis存储验证码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Redis%E5%AD%98%E5%82%A8%E7%99%BB%E5%BD%95%E5%87%AD%E8%AF%81"><span class="toc-text">使用Redis存储登录凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Redis%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">使用Redis存储用户信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#21-Kafka%E5%8F%91%E9%80%81%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5"><span class="toc-text">21. Kafka发送系统通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BD%BF%E7%94%A8Kafka"><span class="toc-text">命令行使用Kafka</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring%E6%95%B4%E5%90%88Kafka"><span class="toc-text">Spring整合Kafka</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E9%80%9A%E7%9F%A5"><span class="toc-text">发送通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5"><span class="toc-text">显示系统通知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E9%80%9A%E7%9F%A5%E8%AF%A6%E6%83%85"><span class="toc-text">开发通知详情</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E5%A4%B4%E9%83%A8%E6%98%BE%E7%A4%BA%E6%9C%AA%E8%AF%BB%E6%B6%88%E6%81%AF%E6%80%BB%E6%95%B0"><span class="toc-text">页面头部显示未读消息总数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-Elasticsearch%E5%BC%80%E5%8F%91%E7%A4%BE%E5%8C%BA%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="toc-text">22. Elasticsearch开发社区搜索功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BD%BF%E7%94%A8Elasticsearch"><span class="toc-text">命令行使用Elasticsearch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Postman%E6%93%8D%E4%BD%9CElasticsearch"><span class="toc-text">Postman操作Elasticsearch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring%E6%95%B4%E5%90%88Elasticsearch"><span class="toc-text">Spring整合Elasticsearch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%9C%8D%E5%8A%A1"><span class="toc-text">搜索服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E4%BA%8B%E4%BB%B6"><span class="toc-text">发布事件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-Spring-Security%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-text">23. Spring Security权限控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%AE%E9%A1%B6%E3%80%81%E5%8A%A0%E7%B2%BE%E3%80%81%E5%88%A0%E9%99%A4%E5%8A%9F%E8%83%BD"><span class="toc-text">置顶、加精、删除功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-Redis%E9%AB%98%E7%BA%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-text">24. Redis高级数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1"><span class="toc-text">网站数据统计</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#25-%E4%BC%98%E5%8C%96%E7%BD%91%E7%AB%99%E6%80%A7%E8%83%BD%EF%BC%9A%E7%BC%93%E5%AD%98%E5%B8%96%E5%AD%90"><span class="toc-text">25. 优化网站性能：缓存帖子</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-text">压力测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#26-%E9%A1%B9%E7%9B%AE%E5%8F%91%E5%B8%83"><span class="toc-text">26. 项目发布</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-text">项目部署</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/09/11/JVM/">JVM</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/23/%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%B8%8B%EF%BC%89/">社区项目（下）</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/07/09/%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE%EF%BC%88%E4%B8%8A%EF%BC%89/">社区项目（上）</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/27/SpringMVC/">SpringMVC</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/20/Maven/">Maven</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/19/MyBatis/">MyBatis</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/05/Spring/">Spring</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/21/JavaWeb%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9ACookie%E3%80%81Session%E3%80%81Filter%E3%80%81JSON%E3%80%81AJAX/">JavaWeb（三）：Cookie、Session、Filter、JSON、AJAX</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/08/JavaWeb%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9AXML%E3%80%81Servlet%E3%80%81jsp%E3%80%81EL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E3%80%81JSTL%E6%A0%87%E7%AD%BE%E5%BA%93/">JavaWeb（二）：XML、Servlet、jsp、EL表达式、JSTL标签库</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/08/%E5%B0%9A%E7%A1%85%E8%B0%B7%E4%B9%A6%E5%9F%8E%E9%A1%B9%E7%9B%AE/">尚硅谷书城项目</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/JDBC/" style="font-size: 15px;">JDBC</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Maven/" style="font-size: 15px;">Maven</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/JavaWeb/" style="font-size: 15px;">JavaWeb</a> <a href="/tags/MyBatis/" style="font-size: 15px;">MyBatis</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/SpringMVC/" style="font-size: 15px;">SpringMVC</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 15px;">数据结构</a> <a href="/tags/%E5%B0%9A%E7%A1%85%E8%B0%B7%E4%B9%A6%E5%9F%8E%E9%A1%B9%E7%9B%AE/" style="font-size: 15px;">尚硅谷书城项目</a> <a href="/tags/%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE/" style="font-size: 15px;">社区项目</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">11</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Site Map</a> |  <a href="/atom.xml">Subscribe to this site</a> |  <a href="/about/">Contact the blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Liu Sai.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a target="_blank" rel="noopener" href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>